// Prisma schema for OrderWorks job management

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum JobStatus {
  PENDING   @map("pending")
  PRINTING  @map("printing")
  COMPLETED @map("completed")
}

enum WebhookEventStatus {
  RECEIVED  @map("received")
  PROCESSED @map("processed")
  FAILED    @map("failed")
}

model Job {
  id               String     @id
  paymentIntentId  String     @unique
  totalCents       Int
  currency         String
  lineItems        Json
  shipping         Json?
  metadata         Json?
  userId           String?
  customerEmail    String?
  makerworksCreatedAt DateTime @map("makerworks_created_at")
  status           JobStatus  @default(PENDING)
  invoiceUrl       String?
  notes            String?
  queuePosition    Int        @default(0) @map("queue_position")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  events           MakerWorksWebhookEvent[]

  @@map("jobs")
  @@index([status])
  @@index([makerworksCreatedAt])
  @@index([queuePosition])
}

model MakerWorksWebhookEvent {
  id              String             @id @default(cuid())
  jobId           String?            @map("job_id")
  paymentIntentId String?            @map("payment_intent_id")
  signature       String?
  payload         Json
  headers         Json?
  status          WebhookEventStatus @default(RECEIVED)
  error           String?
  processedAt     DateTime?          @map("processed_at")
  createdAt       DateTime           @default(now()) @map("created_at")

  job             Job?               @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@map("makerworks_webhook_events")
  @@index([jobId])
  @@index([status])
}
